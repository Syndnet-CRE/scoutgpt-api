<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ScoutGPT — GIS Enrichment Live</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;700&display=swap');

  * { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    --green: #00ff41;
    --green-dim: #00aa2a;
    --green-glow: #00ff4133;
    --amber: #ffb000;
    --red: #ff3333;
    --cyan: #00ffff;
    --bg: #0a0a0a;
    --bg-panel: #0d1117;
    --border: #1a2a1a;
  }

  body {
    background: var(--bg);
    color: var(--green);
    font-family: 'JetBrains Mono', monospace;
    font-size: 13px;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* CRT scanline overlay */
  body::after {
    content: '';
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: repeating-linear-gradient(
      0deg,
      transparent,
      transparent 2px,
      rgba(0, 255, 65, 0.015) 2px,
      rgba(0, 255, 65, 0.015) 4px
    );
    pointer-events: none;
    z-index: 9999;
  }

  .container {
    max-width: 1100px;
    margin: 0 auto;
    padding: 20px;
  }

  .header {
    border: 1px solid var(--green-dim);
    padding: 16px 20px;
    margin-bottom: 20px;
    position: relative;
    background: linear-gradient(180deg, #0d1a0d 0%, var(--bg) 100%);
  }

  .header h1 {
    font-size: 18px;
    font-weight: 700;
    letter-spacing: 3px;
    text-transform: uppercase;
    text-shadow: 0 0 10px var(--green-glow);
  }

  .header .subtitle {
    color: var(--green-dim);
    font-size: 11px;
    margin-top: 4px;
    letter-spacing: 1px;
  }

  .header .status-dot {
    position: absolute;
    right: 20px;
    top: 50%;
    transform: translateY(-50%);
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 11px;
  }

  .dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--green);
    box-shadow: 0 0 6px var(--green);
    animation: pulse 1.5s ease-in-out infinite;
  }

  .dot.disconnected { background: var(--red); box-shadow: 0 0 6px var(--red); }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
  }

  /* Summary bar */
  .summary {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
    margin-bottom: 20px;
  }

  .stat-box {
    border: 1px solid var(--border);
    padding: 14px 16px;
    background: var(--bg-panel);
  }

  .stat-box .label {
    font-size: 10px;
    color: var(--green-dim);
    text-transform: uppercase;
    letter-spacing: 2px;
    margin-bottom: 6px;
  }

  .stat-box .value {
    font-size: 26px;
    font-weight: 700;
    text-shadow: 0 0 8px var(--green-glow);
  }

  .stat-box .value.amber { color: var(--amber); text-shadow: 0 0 8px #ffb00033; }
  .stat-box .value.cyan { color: var(--cyan); text-shadow: 0 0 8px #00ffff33; }

  /* Steps grid */
  .steps {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 20px;
  }

  .step-card {
    border: 1px solid var(--border);
    padding: 14px 16px;
    background: var(--bg-panel);
    transition: border-color 0.3s;
  }

  .step-card.active { border-color: var(--amber); }
  .step-card.complete { border-color: var(--green-dim); }
  .step-card.waiting { border-color: var(--border); }

  .step-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
  }

  .step-name {
    font-size: 12px;
    font-weight: 500;
    letter-spacing: 1px;
  }

  .step-status {
    font-size: 10px;
    padding: 2px 8px;
    border: 1px solid;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .step-status.complete { color: var(--green); border-color: var(--green-dim); }
  .step-status.running { color: var(--amber); border-color: var(--amber); animation: pulse 1s infinite; }
  .step-status.pending { color: #555; border-color: #333; }

  .step-bar-bg {
    height: 4px;
    background: #1a1a1a;
    margin-bottom: 8px;
    overflow: hidden;
  }

  .step-bar-fill {
    height: 100%;
    background: var(--green);
    transition: width 0.5s ease;
    box-shadow: 0 0 6px var(--green-glow);
  }

  .step-bar-fill.running { background: var(--amber); box-shadow: 0 0 6px #ffb00033; }

  .step-stats {
    font-size: 11px;
    color: var(--green-dim);
    display: flex;
    justify-content: space-between;
  }

  /* Log panel */
  .log-panel {
    border: 1px solid var(--border);
    background: var(--bg-panel);
    padding: 14px 16px;
    max-height: 250px;
    overflow-y: auto;
  }

  .log-panel .log-title {
    font-size: 10px;
    color: var(--green-dim);
    text-transform: uppercase;
    letter-spacing: 2px;
    margin-bottom: 10px;
  }

  .log-line {
    font-size: 11px;
    padding: 2px 0;
    color: var(--green-dim);
    border-bottom: 1px solid #111;
  }

  .log-line .ts { color: #555; }
  .log-line.ok { color: var(--green); }
  .log-line.err { color: var(--red); }
  .log-line.info { color: var(--cyan); }

  /* Connection error */
  .error-banner {
    background: #1a0000;
    border: 1px solid var(--red);
    color: var(--red);
    padding: 12px 16px;
    margin-bottom: 20px;
    display: none;
    font-size: 12px;
  }

  .footer {
    margin-top: 20px;
    text-align: center;
    font-size: 10px;
    color: #333;
    letter-spacing: 2px;
  }
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>ScoutGPT Enrichment Pipeline</h1>
    <div class="subtitle">PostGIS spatial joins — properties</div>
    <div class="status-dot">
      <div class="dot" id="statusDot"></div>
      <span id="statusText">POLLING</span>
    </div>
  </div>

  <div class="error-banner" id="errorBanner"></div>

  <div class="summary">
    <div class="stat-box">
      <div class="label">Total Parcels</div>
      <div class="value" id="totalParcels">—</div>
    </div>
    <div class="stat-box">
      <div class="label">Enriched</div>
      <div class="value cyan" id="totalEnriched">—</div>
    </div>
    <div class="stat-box">
      <div class="label">Coverage</div>
      <div class="value amber" id="coverage">—</div>
    </div>
    <div class="stat-box">
      <div class="label">Last Poll</div>
      <div class="value" id="lastPoll" style="font-size:14px;margin-top:6px;">—</div>
    </div>
  </div>

  <div class="steps">
    <div class="step-card waiting" id="step1">
      <div class="step-header">
        <span class="step-name">① Parcels Loaded</span>
        <span class="step-status pending" id="step1Status">PENDING</span>
      </div>
      <div class="step-bar-bg"><div class="step-bar-fill" id="step1Bar" style="width:0%"></div></div>
      <div class="step-stats"><span id="step1Count">0</span><span id="step1Pct">0%</span></div>
    </div>

    <div class="step-card waiting" id="step2">
      <div class="step-header">
        <span class="step-name">② Zoning</span>
        <span class="step-status pending" id="step2Status">PENDING</span>
      </div>
      <div class="step-bar-bg"><div class="step-bar-fill" id="step2Bar" style="width:0%"></div></div>
      <div class="step-stats"><span id="step2Count">0</span><span id="step2Pct">0%</span></div>
    </div>

    <div class="step-card waiting" id="step3">
      <div class="step-header">
        <span class="step-name">③ Flood Zones</span>
        <span class="step-status pending" id="step3Status">PENDING</span>
      </div>
      <div class="step-bar-bg"><div class="step-bar-fill" id="step3Bar" style="width:0%"></div></div>
      <div class="step-stats"><span id="step3Count">0</span><span id="step3Pct">0%</span></div>
    </div>

    <div class="step-card waiting" id="step4">
      <div class="step-header">
        <span class="step-name">④ Nearest Water</span>
        <span class="step-status pending" id="step4Status">PENDING</span>
      </div>
      <div class="step-bar-bg"><div class="step-bar-fill" id="step4Bar" style="width:0%"></div></div>
      <div class="step-stats"><span id="step4Count">0</span><span id="step4Pct">0%</span></div>
    </div>

    <div class="step-card waiting" id="step5">
      <div class="step-header">
        <span class="step-name">⑤ Nearest Sewer</span>
        <span class="step-status pending" id="step5Status">PENDING</span>
      </div>
      <div class="step-bar-bg"><div class="step-bar-fill" id="step5Bar" style="width:0%"></div></div>
      <div class="step-stats"><span id="step5Count">0</span><span id="step5Pct">0%</span></div>
    </div>

    <div class="step-card waiting" id="step6">
      <div class="step-header">
        <span class="step-name">⑥ Nearest Storm</span>
        <span class="step-status pending" id="step6Status">PENDING</span>
      </div>
      <div class="step-bar-bg"><div class="step-bar-fill" id="step6Bar" style="width:0%"></div></div>
      <div class="step-stats"><span id="step6Count">0</span><span id="step6Pct">0%</span></div>
    </div>
  </div>

  <div class="log-panel">
    <div class="log-title">▸ Activity Log</div>
    <div id="logLines"></div>
  </div>

  <div class="footer">SCOUTGPT GIS ENRICHMENT MONITOR v1.0 — NEON POSTGRESQL</div>
</div>

<script type="module">
  import { neon } from 'https://esm.sh/@neondatabase/serverless@0.9.0';

  // Use the pooler connection string — the serverless driver works over HTTP with pooler too
  const sql = neon('postgresql://neondb_owner:npg_1IpbVsgTid5k@ep-weathered-cell-aekdgszb-pooler.c-2.us-east-2.aws.neon.tech/neondb?sslmode=require');

  const POLL_INTERVAL = 3000;
  let prevState = null;
  let logEntries = [];

  function addLog(msg, type = 'info') {
    const ts = new Date().toLocaleTimeString();
    logEntries.unshift({ ts, msg, type });
    if (logEntries.length > 50) logEntries.pop();
    renderLog();
  }

  function renderLog() {
    const el = document.getElementById('logLines');
    el.innerHTML = logEntries.map(l =>
      `<div class="log-line ${l.type}"><span class="ts">[${l.ts}]</span> ${l.msg}</div>`
    ).join('');
  }

  function fmt(n) {
    return n == null ? '—' : Number(n).toLocaleString();
  }

  function updateStep(num, count, total, prevCount) {
    const pct = total > 0 ? (count / total * 100) : 0;
    const card = document.getElementById(`step${num}`);
    const status = document.getElementById(`step${num}Status`);
    const bar = document.getElementById(`step${num}Bar`);
    const countEl = document.getElementById(`step${num}Count`);
    const pctEl = document.getElementById(`step${num}Pct`);

    countEl.textContent = `${fmt(count)} / ${fmt(total)}`;
    pctEl.textContent = `${pct.toFixed(1)}%`;
    bar.style.width = `${pct}%`;

    if (count > 0 && count >= total && total > 0) {
      card.className = 'step-card complete';
      status.className = 'step-status complete';
      status.textContent = 'COMPLETE';
      bar.className = 'step-bar-fill';
    } else if (count > 0 && count !== prevCount) {
      card.className = 'step-card active';
      status.className = 'step-status running';
      status.textContent = 'RUNNING';
      bar.className = 'step-bar-fill running';
    } else if (count > 0) {
      card.className = 'step-card complete';
      status.className = 'step-status complete';
      status.textContent = 'COMPLETE';
      bar.className = 'step-bar-fill';
    } else {
      card.className = 'step-card waiting';
      status.className = 'step-status pending';
      status.textContent = 'PENDING';
    }
  }

  async function poll() {
    try {
      // Single query to get all enrichment stats
      const rows = await sql`
        SELECT 
          COUNT(*) AS total,
          COUNT(zoning_local) AS zoning,
          COUNT(flood_zone) AS flood,
          COUNT(nearest_water_ft) AS water,
          COUNT(nearest_sewer_ft) AS sewer,
          COUNT(nearest_storm_ft) AS storm
        FROM properties
      `;

      const r = rows[0];
      const total = Number(r.total);
      const counts = {
        parcels: total,
        zoning: Number(r.zoning),
        flood: Number(r.flood),
        water: Number(r.water),
        sewer: Number(r.sewer),
        storm: Number(r.storm),
      };

      // Total enriched = parcels that have at least one enrichment field
      const enrichedRows = await sql`
        SELECT COUNT(*) AS n FROM properties 
        WHERE zoning_local IS NOT NULL 
           OR flood_zone IS NOT NULL 
           OR nearest_water_ft IS NOT NULL
      `;
      const enriched = Number(enrichedRows[0].n);

      // Update summary
      document.getElementById('totalParcels').textContent = fmt(total);
      document.getElementById('totalEnriched').textContent = fmt(enriched);
      document.getElementById('coverage').textContent = total > 0 ? `${(enriched/total*100).toFixed(1)}%` : '—';
      document.getElementById('lastPoll').textContent = new Date().toLocaleTimeString();

      // Update steps
      const prev = prevState || counts;
      updateStep(1, counts.parcels, counts.parcels, prev.parcels); // parcels loaded is binary
      updateStep(2, counts.zoning, total, prev.zoning);
      updateStep(3, counts.flood, total, prev.flood);
      updateStep(4, counts.water, total, prev.water);
      updateStep(5, counts.sewer, total, prev.sewer);
      updateStep(6, counts.storm, total, prev.storm);

      // Log changes
      if (prevState) {
        for (const [key, label] of [['parcels','Parcels'],['zoning','Zoning'],['flood','Flood'],['water','Water'],['sewer','Sewer'],['storm','Storm']]) {
          const diff = counts[key] - prev[key];
          if (diff > 0) {
            addLog(`${label}: +${fmt(diff)} → ${fmt(counts[key])} total`, 'ok');
          }
        }
      } else {
        addLog(`Connected — ${fmt(total)} parcels in database`, 'info');
      }

      prevState = counts;

      // Status indicator
      document.getElementById('statusDot').className = 'dot';
      document.getElementById('statusText').textContent = 'CONNECTED';
      document.getElementById('errorBanner').style.display = 'none';

    } catch (err) {
      console.error('Poll error:', err);
      document.getElementById('statusDot').className = 'dot disconnected';
      document.getElementById('statusText').textContent = 'ERROR';
      document.getElementById('errorBanner').textContent = `Connection error: ${err.message}`;
      document.getElementById('errorBanner').style.display = 'block';
      addLog(`Poll failed: ${err.message}`, 'err');
    }
  }

  // Initial poll + interval
  addLog('Initializing enrichment monitor...', 'info');
  poll();
  setInterval(poll, POLL_INTERVAL);
</script>
</body>
</html>
